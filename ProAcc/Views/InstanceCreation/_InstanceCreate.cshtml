

@{
    ViewBag.Title = "Create Instance";
}
    <link href="~/Asset/css/Activity.css" rel="stylesheet" />

<a class="card-title">Instance Creation</a>
<hr />
<div style="padding:1em;">
    <div class="row">
        <div class="col-6">

            <input type="hidden" id="Instid" />
            <input type="hidden" id="Instcre_on" />
            <input type="hidden" id="Instcre_By" />

            <div class="form-group">
                <label class="control-label col-md-4 required">Instance Name</label>
                <div class="col-md-10">
                    <input type="text" class="form-control txtInstanceName" id="txtInstanceName" maxlength="3" />
                    @*<span id="lblInstanceName" style="color:red" />*@
                </div>
                <div>
                    &nbsp;&nbsp;&nbsp;<span class="Class_span" id="lblInstanceName">&nbsp;</span>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-4 required">Project</label>
                <div class="col-md-10">
                    <select class="form-control" id="drpProject">
                        <option value="0">Select Project</option>
                        @foreach (var item in ViewBag.project)
                        {
                            <option value="@item.Project_Id">@item.Project_Name</option>
                        }
                    </select>
                    @*<span id="lblProject" style="color:red" />*@
                </div>
                <div>
                    &nbsp;&nbsp;&nbsp;<span class="Class_span" id="lblProject">&nbsp;</span>
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="button" value="Create" class="btn btn-primary" id="btnInstanceCreate" />
                    <input type="button" value="Update" class="btn btn-info" id="btnInstanceUpdate" style="display:none" />
                    <input type="button" value="Clone" class="btn btn-info" id="btnClone" onclick="document.getElementById('id01').style.display='block'"/>
                    <a class="btn btn-success" id="btnAddNew" style="display:none"><i class="fa fa-plus"></i>Add New</a>
                </div>
            </div>
        </div>

        
    </div>
</div>

<div class="w3-container">
    <div id="id01" class="w3-modal">
        <div class="w3-modal-content" style="margin-left: 355px;margin-top: 110px; height:20%;">
            <div class="w3-container" style="margin:0 auto !important;">
                <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-display-topright">&times;</span>
                <div class="row" style="margin-top:3%;">
                    <div class="col-4">
                        <label class="control-label col-md-4 required">Project</label>
                        <select class="form-control" id="drpProjectName">
                            <option value="0">Select Project</option>
                            @foreach (var item in ViewBag.project)
                            {
                                <option value="@item.Project_Id">@item.Project_Name</option>
                            }
                        </select>
                        <span class="Class_span" id="lblProjectName">&nbsp;</span>
                    </div>
                    <div class="col-2">
                        <label class="control-label col-md-4 required">Instance</label>
                        <select class="form-control" id="drpInstance">
                        </select>
                    </div>
                    <div class="col-3">
                        <label class="control-label col-md-4 required">Instance</label>
                        <input type="text" id="txtInstance1" class="form-control txtInstanceName" maxlength="3" style="border: 2px solid #ccc !important" />
                        <span class="Class_span" id="lblInstance1">&nbsp;</span>
                    </div>
                    <div class="col-1"></div>
                    <div class="col-2">
                        <label class="control-label col-md-4"></label>
                        <button type="button" id="btnCloneSave" class="btn btn-primary" style="margin-bottom:50px !important;">Clone&Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        $("#btnInstanceCreate").prop('disabled', true);

        $(".txtInstanceName").keypress(function (event) {
        
            var regex = new RegExp("^[a-zA-Z0-9 ]+$");
            var str = String.fromCharCode(!event.charCode ? event.which : event.charCode);
            if (!regex.test(str)) {
                event.preventDefault();
                $("#lblInstanceName").html("Not Allowed").show().fadeOut(5000);
            }
            else {
                $("#btnInstanceCreate").prop('disabled', false);
            }
           
        });

        $('#drpProjectName').change(function () {
            var Project = $("#drpProjectName").val().trim();

            $.ajax({
                url: '@Url.Action("GetInstancesByProject", "InstanceCreation")',
                dataType: "json",
                async: false,
			    contentType: "application/json; charset=utf-8",
                data: { id: Project},
                success: function (res) {
                    $.each(res, function (data, value) {
                        $('#drpInstance').append($("<option value='" + value.Instance_id + "'>" + value.InstaceName + "</option>"));                                                       
                    })
                },
                error: function (err) {
                    alert(err);
                }
            })
        });

        $("#btnCloneSave").on("click", function () {

            var InstanceName = $("#txtInstance1").val().trim();
            var Project = $("#drpProjectName").val().trim();        
            var Previous_Instance = $("#drpInstance").val().trim();        

            if (InstanceName == "") {
                $("#lblInstance1").html("Please enter the Instance Name").show().fadeOut(5000);
            }
            else if (Project == 0) {
                $("#lblProjectName").html("Please Select the project").show().fadeOut(5000);
            }
            else {
                  $.ajax({
                    type: "POST",
                    url: '@Url.Action("CreateClone","InstanceCreation")',
                    data: { InstaceName: InstanceName, Project_ID: Project,Previous_Instance:Previous_Instance },
                        success: function (response) {
                            if (response == "success") {
                                Notiflix.Notify.Success('Instance Cloned successfully..!', { cssAnimationStyle: 'zoom', cssAnimationDuration: 500, });
                                location.reload();
                            }
                            else {
                               Notiflix.Notify.Success('Instance Not Cloned..!', { cssAnimationStyle: 'zoom', cssAnimationDuration: 500, });
                            }
                        },
                        failure: function (response) {
                           alert(response.responseText);
                        },
                        error: function (response) {
                            alert(response.responseText);
                        }
                });
            }

        });


        $('#drpProject').change(function () {
            
            var InstName = $("#txtInstanceName").val().trim();
            var Project = $("#drpProject").val().trim();
            //if (InstName != null && Project != "") {            
            //    $("#btnInstanceCreate").prop('disabled', false);            
            //}            
            $.ajax({
                url: '@Url.Action("CheckInstanceProjectAvailability", "InstanceCreation")',
                type: "GET",
                data: { namedata: InstName, project: Project},
                dataType: "json",
                success: function (data) {
                    if (data != "success") {
                        $("#lblInstanceName").html("This Instance Name is already in use for this project").show().fadeOut(5000);
                        $("#btnInstanceCreate").prop('disabled', true);
                        // $("#btnInstanceUpdate").prop('disabled', true);
                    }
                    else {
                        $("#lblInstanceName").html("").hide();
                        $("#btnInstanceCreate").prop('disabled', false);
                        //$("#btnInstanceUpdate").prop('disabled', false);
                    }
                },
                error: function (err) {
                    alert(err);
                }
            })        });
    });


    $("#btnInstanceCreate").on("click", function () {
        
        var InstanceName = $("#txtInstanceName").val().trim();
        var Project = $("#drpProject").val().trim();        

        if (InstanceName == "") {
            $("#lblInstanceName").html("Please enter the Instance Name").show().fadeOut(5000);
        }
        else if (Project ==0)
        {
            $("#lblProject").html("Please Select the project").show().fadeOut(5000);
        }
        else {
            $.ajax({
                    type: "POST",
                url: '@Url.Action("Create","InstanceCreation")',
                data: { InstaceName: InstanceName, Project_ID: Project },
                    success: function (response) {
                        if (response == "success") {
                            Notiflix.Notify.Success('Instance Saved successfully..!', { cssAnimationStyle: 'zoom', cssAnimationDuration: 500, });
                            loadInstanceTable();
                            $("#txtInstanceName").val("")
                            $("#drpProject").val(0)
                            $(".app-main_Scroll").animate({ scrollTop: 300 }, 1000);
                            //$.alert({
                            //    title: 'Success !',
                            //    content: 'Instance Saved successfully..!',// <br> with some <strong>HTML</strong> <em>contents</em>',
                            //    icon: 'fa fa-rocket',
                            //    animation: 'scale',
                            //    closeAnimation: 'scale',
                            //    buttons: {
                            //        okay: {
                            //            text: 'Okay',
                            //            btnClass: 'btn-wide mb-2 mr-2 btn btn-primary form-control',
                            //            action: function (event, ui) {
                            //                loadInstanceTable();
                            //                $("#txtInstanceName").val("")
                            //                $("#drpProject").val(0)
                            //            }
                            //        }
                            //    }
                            //});
                        }
                        else {
                            $("#lblInstanceName").html("This Instance Name is already in use for this project").show().fadeOut(5000);
                            $("#btnInstanceCreate").prop('disabled', true);
                        }
                    },
                    failure: function (response) {
                       alert(response.responseText);
                    },
                error: function (response) {
                        alert(response.responseText);
                    }
            });



        }
    });


     $("#btnInstanceUpdate").on("click", function () {
         var id = $("#Instid").val();
        var InstanceName = $("#txtInstanceName").val().trim();
        var Project = $("#drpProject").val().trim();      
        var cre_on = $("#Instcre_on").val();
        var cre_By = $("#Instcre_By").val();

         var model = {
             Instance_id: id,
             InstaceName: InstanceName,
             Project_ID: Project,
             Cre_on: cre_on,
             Cre_By: cre_By
         }
       if (InstanceName == "") {
            $("#lblInstanceName").html("Please enter the Instance Name").show().fadeOut(5000);
        }
        else if (Project ==0)
        {
            $("#lblProject").html("Please Select the project").show().fadeOut(5000);
        }
        else {

            $.ajax({
                    type: "POST",
                    url: '@Url.Action("Edit","InstanceCreation")',
                    data: { model : model},
                    success: function (response) {
                        if (response == "success") {
                             Notiflix.Notify.Success('Instance Update successfully..!', { cssAnimationStyle: 'zoom', cssAnimationDuration: 500, });
                            loadInstanceTable();
                                            $("#txtInstanceName").val("")
                                            $("#drpProject").val(0)
                                            $("#btnInstanceUpdate").hide();
                                            $("#btnInstanceCreate").show();

                            //$.alert({
                            //    title: 'Success !',
                            //    content: 'Instance Edited successfully..!',
                            //    icon: 'fa fa-rocket',
                            //    animation: 'scale',
                            //    closeAnimation: 'scale',
                            //    buttons: {
                            //        okay: {
                            //            text: 'Okay',
                            //            btnClass: 'btn-wide mb-2 mr-2 btn btn-primary form-control',
                            //            action: function (event, ui) {
                            //                loadInstanceTable();
                            //                $("#txtInstanceName").val("")
                            //                $("#drpProject").val(0)
                            //                $("#btnInstanceUpdate").hide();
                            //                $("#btnInstanceCreate").show();
                            //            }
                            //        }
                            //    }
                            //});
                            //alert("Instance Edited successfully!");
                            //loadInstanceTable();
                            //$("#txtInstanceName").val("")
                            //$("#drpProject").val(0)
                            //$("#btnInstanceUpdate").hide();
                            //$("#btnInstanceCreate").show();
                        }
                    },
                    failure: function (response) {
                       alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
            });

        }
     });


</script>
